# PR Reviewer Assignment Service

Сервис назначения ревьюеров для Pull Request’ов.

Сервис для автоматического назначения код-ревьюверов в командах разработки. Сервис управляет пользователями и командами, автоматически выбирает ревьюверов для новых Pull Request'ов (исключая автора) и поддерживает процесс переназначения при отсутствии сотрудника.

## Технический стек

*   Язык: Go 1.25
*   База данных: PostgreSQL
*   Роутер: Gin
*   Миграции: golang-migrate
*   Контейнеризация: Docker + Docker Compose
*   Нагрузочное тестирование: k6

## Как запустить

Для работы сервиса необходимы установленные Docker и Docker Compose.

1. Склонируйте репозиторий и перейдите в директорию проекта:
```
    git clone https://github.com/yohnnn/pr_reviewer_assignment_service.git
    cd pr_reviewer_assignment_service
```
2. Запустите проект командой:
```
    make docker-up
```
После успешного запуска будут доступны:
*   API Сервиса: http://localhost:8080
*   Swagger UI: http://localhost:8081

## Команды Makefile

В проекте предусмотрен Makefile для удобства разработки:

| Команда | Описание |
| :--- | :--- |
| `make docker-up` | Поднять сервис и базу данных в Docker (с миграциями) |
| `make docker-down` | Остановить и удалить контейнеры |
| `make test` | Запуск Unit-тестов |
| `make test-e2e` | Запуск E2E тестов (требует поднятого docker-up) |
| `make lint` | Проверка кода линтером (golangci-lint) |

## API Эндпоинты


### Teams
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| POST | `/team/add` | Создать команду с участниками (создаёт/обновляет пользователей) |
| GET | `/team/get` | Получить команду с участниками |

### Users 
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| POST | `/users/setIsActive` | Установить флаг активности пользователя |
| POST | `/users/deactivate` | Массовая деактивация пользователей с переназначением ревью |
| GET | `/users/getReview` | Получить PR'ы, где пользователь назначен ревьювером |

### Pull Requests 
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| POST | `/pullRequest/create` | Создать PR и автоматически назначить до 2 ревьюверов |
| POST | `/pullRequest/merge` | Пометить PR как MERGED |
| POST | `/pullRequest/reassign` | Переназначить конкретного ревьювера на другого из его команды |

### Info 
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| GET | `/stats` | Получить статистику по количеству ревью у пользователей |

## Структура проекта
```
├── api
├── cmd
├── internal
│   ├── app
│   │   ├── handlers
│   │   │   └── requests
│   │   └── router
│   ├── config
│   ├── logger
│   ├── models
│   ├── repository
│   │   ├── inmemory
│   │   └── postgres
│   └── services
├── migrations
└── tests
    ├── e2e_test
    └── stress_testing
```

## Выполненные дополнительные задания

В рамках тестового задания были реализованы следующие доп пункты:

1.  **E2E Тестирование:** Реализован полный сценарий проверки работы сервиса (package httpexpect). Тесты проверяют все основные сценарии.
2.  **Нагрузочное тестирование:** Проведено тестирование производительности с помощью k6. Отчет о нем ниже
3.  **Массовая деактивация:** Реализован алгоритм деактивации пользователей с безопасным переназначением их активных ревью на других членов команды.
4.  **Статистика:** Добавлен эндпоинт для просмотра топ-загруженных ревьюверов.
5.  **Линтер:** Настроен конфигурационный файл .golangci.yml.


## Допущения и решения

1. В моем решении у PR ревьюверы всегда будут из одной команды.
2. ```/users/deactivate``` работает следующим образом. Прилетает список из айди юзеров. Каждого деактивирует и переназначает их PR на доступных, если доступных нет, то он просто удаляется из ревьюверов.
3. При вызове ```/users/setIsActive``` если ```isActive = true```, то просто меняем в базе на true, если false, то вызываем деактивацию для этого юзера, чтобы переназначить PR которые он ревьювит.




# Результаты нагрузочного тестирования (k6)

Провел нагрузочное тестирование сервиса, чтобы проверить стабильность и скорость работы.
Ниже описаны настройки, с которыми запускался тест, и полученные результаты.

## Настройки тестирования
*   **Сценарий:** `tests/stress_testing/test.js`
*   **База данных:** Предварительно заполнена (20 команд, 200 пользователей).
*   **Целевая нагрузка:** Ограничена скриптом до **5 RPS** (согласно требованиям ТЗ).
*   **Тестируемые эндпоинты:**
    *   `/users/deactivate`
    *   `/pullRequest/create`
    *   `/pullRequest/merge`
    *   `/stats`

## Результаты

Тест прошел успешно. Сервис выдержал заданную нагрузку без ошибок и задержек.

### Статистика по эндпоинтам
Разбивка производительности по конкретным операциям. Самой тяжелой операцией оказалась деактивация, но даже она выполняется очень быстро (9.49 ms в p95).

| Операция | RPS | Avg Time | p95 Time |
| :--- | :--- | :--- | :--- |
| **Deactivate Users** | 0.55 | 6.72 ms | 9.49 ms |
| **Create PR** | 1.66 | 5.93 ms | 7.66 ms |
| **Merge PR** | 1.40 | 3.34 ms | 4.35 ms |
| **Get Stats** | — | 2.49 ms | 4.22 ms |

### Сравнение с требованиями

| Параметр | Требования | Результат |
| :--- | :--- | :--- |
| **RPS** | 5 req/s | **6.32 req/s** |
| **Latency** | < 300 ms | **~8 ms** |
| **Success Rate** | 99.9% | **100%** |
